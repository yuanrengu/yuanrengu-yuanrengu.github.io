<!DOCTYPE html>





<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo-32x32.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo-16x16.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<script data-ad-client="ca-pub-6394975472135022" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.3.0',
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: ''
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="温馨提示：在这里我再次提个小要求，希望大家能习惯看官方文档，文档虽然是英文但用词都比较简单，基本都能看懂文档表达的意思。授之以鱼不如授之以渔的道理相信大家都明白，也希望通过猿人谷的这个ZooKeeper系列，让大家入门、到熟悉，举一反三后能精通ZooKeeper。  在前一篇我们介绍了ZooKeeper单机版、伪集群和集群环境搭建 ，通过命令行的方式做了节点的创建、删除、更新、获取节点信息的测试">
<meta name="keywords" content="ZooKeeper,Java">
<meta property="og:type" content="article">
<meta property="og:title" content="【ZooKeeper系列】2.用Java实现ZooKeeper API的调用">
<meta property="og:url" content="https://yuanrengu.com/2020/469cbe7.html">
<meta property="og:site_name" content="猿人谷">
<meta property="og:description" content="温馨提示：在这里我再次提个小要求，希望大家能习惯看官方文档，文档虽然是英文但用词都比较简单，基本都能看懂文档表达的意思。授之以鱼不如授之以渔的道理相信大家都明白，也希望通过猿人谷的这个ZooKeeper系列，让大家入门、到熟悉，举一反三后能精通ZooKeeper。  在前一篇我们介绍了ZooKeeper单机版、伪集群和集群环境搭建 ，通过命令行的方式做了节点的创建、删除、更新、获取节点信息的测试">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-02-14T12:27:14.530Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【ZooKeeper系列】2.用Java实现ZooKeeper API的调用">
<meta name="twitter:description" content="温馨提示：在这里我再次提个小要求，希望大家能习惯看官方文档，文档虽然是英文但用词都比较简单，基本都能看懂文档表达的意思。授之以鱼不如授之以渔的道理相信大家都明白，也希望通过猿人谷的这个ZooKeeper系列，让大家入门、到熟悉，举一反三后能精通ZooKeeper。  在前一篇我们介绍了ZooKeeper单机版、伪集群和集群环境搭建 ，通过命令行的方式做了节点的创建、删除、更新、获取节点信息的测试">
  <link rel="alternate" href="/atom.xml" title="猿人谷" type="application/atom+xml">
  <link rel="canonical" href="https://yuanrengu.com/2020/469cbe7">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>【ZooKeeper系列】2.用Java实现ZooKeeper API的调用 | 猿人谷</title>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-87311079-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-87311079-1');
    }
  </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?499dfe5d674d943f23758606c7806bed";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">猿人谷</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">技术成长，没有捷径，唯有积累</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
      
    

    <a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-links">
      
    

    <a href="/links" rel="section"><i class="menu-item-icon fa fa-fw fa-link"></i> <br>友链</a>

  </li>
    </ul>
    

</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yuanrengu.com/2020/469cbe7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="猿人谷">
      <meta itemprop="description" content="技术成长，没有捷径，唯有积累。">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿人谷">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">【ZooKeeper系列】2.用Java实现ZooKeeper API的调用

              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-01-09 16:27:32" itemprop="dateCreated datePublished" datetime="2020-01-09T16:27:32+08:00">2020-01-09</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-02-14 20:27:14" itemprop="dateModified" datetime="2020-02-14T20:27:14+08:00">2020-02-14</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ZooKeeper/" itemprop="url" rel="index"><span itemprop="name">ZooKeeper</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon"
              >
                <i class="fa fa-eye"></i>
                 阅读次数： 
                <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
              </span>
            </span>
          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">33k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">30 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p><code>温馨提示</code>：在这里我再次提个小要求，希望大家能习惯看<strong>官方文档</strong>，文档虽然是英文但用词都比较简单，基本都能看懂文档表达的意思。<strong>授之以鱼不如授之以渔</strong>的道理相信大家都明白，也希望通过猿人谷的这个ZooKeeper系列，让大家入门、到熟悉，举一反三后能精通ZooKeeper。</p>
</blockquote>
<p>在前一篇我们介绍了<a href="https://yuanrengu.com/2020/3bf330a5.html">ZooKeeper单机版、伪集群和集群环境搭建</a> ，通过命令行的方式做了节点的创建、删除、更新、获取节点信息的测试。Zookeeper 的目的是为客户端构建复杂的协调功能提供简单、高效的核心 API，这一篇我们用Java通过ZooKeeper提供的API接口来实现这些增删改查的功能。</p>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h2><p><code>org.apache.zookeeper.Zookeeper</code>是ZooKeeper客户端的主类，在<a href="http://zookeeper.apache.org/doc/r3.5.5/api/index.html" target="_blank" rel="noopener">官方文档</a> （<strong>该系列文章以v3.5.5为主</strong>，v3.6.6的API Docs还没有）中已明确说明（This is the main class of ZooKeeper client library.）。</p>
<blockquote>
<p>This is the main class of ZooKeeper client library. To use a ZooKeeper service, an application must first instantiate an object of ZooKeeper class. All the iterations will be done by calling the methods of ZooKeeper class. The methods of this class are thread-safe unless otherwise noted.<br>Once a connection to a server is established, a session ID is assigned to the client. The client will send heart beats to the server periodically to keep the session valid.</p>
</blockquote>
<p>创建一个ZooKeeper的实例来使用<code>org.apache.zookeeper.Zookeeper</code>里的方法，官方文档已经指出没有特别声明的话，ZooKeeper类里的方法是<code>线程安全</code>的。客户端连接到ZooKeeper服务的时候，会给客户端分配一个会话ID（session ID），客户端与服务端会通过心跳来保持会话有效。</p>
<p><code>org.apache.zookeeper.Zookeeper</code>里的方法非常多，就不一一列举了，只列几个增删改查的。</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>create(String path, byte[] data, List acl, CreateMode createMode)</td>
<td>Create a node with the given path. （创建指定路径的节点）</td>
</tr>
<tr>
<td>create(String path, byte[] data, List acl, CreateMode createMode, AsyncCallback.Create2Callback cb, Object ctx)</td>
<td>The asynchronous version of create.（异步形式创建）</td>
</tr>
<tr>
<td>create(String path, byte[] data, List acl, CreateMode createMode, Stat stat)</td>
<td>Create a node with the given path and returns the Stat of that node.（按指定路径创建节点并返回节点状态信息）</td>
</tr>
<tr>
<td>delete(String path, int version)</td>
<td>Delete the node with the given path.（删除指定路径的节点）</td>
</tr>
<tr>
<td>delete(String path, int version, AsyncCallback.VoidCallback cb, Object ctx)</td>
<td>The asynchronous version of delete.（异步删除指定路径的节点）</td>
</tr>
<tr>
<td>exists(String path, boolean watch)</td>
<td>Return the stat of the node of the given path.（返回指定路径的节点状态信息）</td>
</tr>
<tr>
<td>getChildren(String path, boolean watch)</td>
<td>Return the list of the children of the node of the given path.（返回指定路径的所有子节点状态信息）</td>
</tr>
<tr>
<td>getData(String path, boolean watch, Stat stat)</td>
<td>Return the data and the stat of the node of the given path.（返回指定路径的节点数据和状态信息）</td>
</tr>
<tr>
<td>setData(String path, byte[] data, int version)</td>
<td>Set the data for the node of the given path if such a node exists and the given version matches the version of the node (if the given version is -1, it matches any node’s versions).（给指定路径和版本的节点设置新值，如版本为-1，即给所有版本设置值）</td>
</tr>
</tbody></table>
<h2 id="2-测试环境搭建"><a href="#2-测试环境搭建" class="headerlink" title="2 测试环境搭建"></a>2 测试环境搭建</h2><p>这里新建一个<strong>Spring Boot</strong>的项目来进行测试，新建Spring Boot项目的过程很简单，也不是这里的重点，就不做介绍了。</p>
<p>项目里会需要额外引入两个包来进行测试：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-API测试"><a href="#3-API测试" class="headerlink" title="3 API测试"></a>3 API测试</h2><p>完整测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  简单测试示例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 猿人谷</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/12/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ZooKeeperDemo.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIME_OUT = <span class="number">10000</span>;</span><br><span class="line">    <span class="comment">// ZooKeeper服务的地址，如为集群，多个地址用逗号分隔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_STRING = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZNODE_PATH = <span class="string">"/zk_demo"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZNODE_PATH_PARENT = <span class="string">"/app1"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZNODE_PATH_CHILDREN = <span class="string">"/app1/app1_1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        zk = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, SESSION_TIME_OUT, <span class="keyword">new</span> Watcher()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"已经触发了"</span> + event.getType() + <span class="string">"事件！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreate</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        zk.create(ZNODE_PATH, <span class="string">"anna2019"</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateParentZnode</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        zk.create(ZNODE_PATH_PARENT, <span class="string">"anna2019"</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateChildrenZnode</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        zk.create(ZNODE_PATH_CHILDREN, <span class="string">"anna2020"</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGet</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] data1 = zk.getData(ZNODE_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data2 = zk.getData(ZNODE_PATH_PARENT, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data3 = zk.getData(ZNODE_PATH_CHILDREN, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        LOGGER.info(<span class="string">"&#123;&#125;的信息：&#123;&#125;"</span>, ZNODE_PATH, <span class="keyword">new</span> String(data1) );</span><br><span class="line">        LOGGER.info(<span class="string">"&#123;&#125;的信息：&#123;&#125;"</span>, ZNODE_PATH_PARENT, <span class="keyword">new</span> String(data2) );</span><br><span class="line">        LOGGER.info(<span class="string">"&#123;&#125;的信息：&#123;&#125;"</span>, ZNODE_PATH_CHILDREN, <span class="keyword">new</span> String(data3) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  删除</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 指定要删除的版本，-1表示删除所有版本</span></span><br><span class="line">        zk.delete(ZNODE_PATH, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  删除含有子节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteHasChildrenZnode</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 指定要删除的版本，-1表示删除所有版本</span></span><br><span class="line">        zk.delete(ZNODE_PATH_PARENT, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSet</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">        Stat stat = zk.setData(ZNODE_PATH, <span class="string">"yuanrengu"</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">        LOGGER.info(stat.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面有用到<code>@Before</code>，简单说明下：</p>
<ul>
<li>@BeforeClass – 表示在类中的任意public static void方法执行之前执行</li>
<li>@AfterClass – 表示在类中的任意public static void方法执行之后执行</li>
<li>@Before – 表示在任意使用@Test注解标注的public void方法执行之前执行</li>
<li>@After – 表示在任意使用@Test注解标注的public void方法执行之后执行</li>
<li>@Test – 使用该注解标注的public void方法会表示为一个测试方法</li>
</ul>
<p>如果将<strong>SESSION_TIME_OUT</strong>设置的时间太短，会报API客户端异常：<code>org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /zk_demo</code> 。完整的报错信息如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">09:33:52.139 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxnSocketNIO - Ignoring exception during shutdown input</span><br><span class="line">java.net.SocketException: Socket is not connected</span><br><span class="line">	at sun.nio.ch.Net.translateToSocketException(Net.java:123)</span><br><span class="line">	at sun.nio.ch.Net.translateException(Net.java:157)</span><br><span class="line">	at sun.nio.ch.Net.translateException(Net.java:163)</span><br><span class="line">	at sun.nio.ch.SocketAdaptor.shutdownInput(SocketAdaptor.java:401)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxnSocketNIO.cleanup(ClientCnxnSocketNIO.java:198)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1338)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.cleanAndNotifyState(ClientCnxn.java:1276)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1254)</span><br><span class="line">Caused by: java.nio.channels.NotYetConnectedException: null</span><br><span class="line">	at sun.nio.ch.SocketChannelImpl.shutdownInput(SocketChannelImpl.java:782)</span><br><span class="line">	at sun.nio.ch.SocketAdaptor.shutdownInput(SocketAdaptor.java:399)</span><br><span class="line">	... 4 common frames omitted</span><br><span class="line">09:33:52.140 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxnSocketNIO - Ignoring exception during shutdown output</span><br><span class="line">java.net.SocketException: Socket is not connected</span><br><span class="line">	at sun.nio.ch.Net.translateToSocketException(Net.java:123)</span><br><span class="line">	at sun.nio.ch.Net.translateException(Net.java:157)</span><br><span class="line">	at sun.nio.ch.Net.translateException(Net.java:163)</span><br><span class="line">	at sun.nio.ch.SocketAdaptor.shutdownOutput(SocketAdaptor.java:409)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxnSocketNIO.cleanup(ClientCnxnSocketNIO.java:205)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1338)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.cleanAndNotifyState(ClientCnxn.java:1276)</span><br><span class="line">	at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1254)</span><br><span class="line">Caused by: java.nio.channels.NotYetConnectedException: null</span><br><span class="line">	at sun.nio.ch.SocketChannelImpl.shutdownOutput(SocketChannelImpl.java:799)</span><br><span class="line">	at sun.nio.ch.SocketAdaptor.shutdownOutput(SocketAdaptor.java:407)</span><br><span class="line">	... 4 common frames omitted</span><br><span class="line"></span><br><span class="line">org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /zk_demo</span><br><span class="line"></span><br><span class="line">	at org.apache.zookeeper.KeeperException.create(KeeperException.java:102)</span><br><span class="line">	at org.apache.zookeeper.KeeperException.create(KeeperException.java:54)</span><br><span class="line">	at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:2131)</span><br><span class="line">	at org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:2160)</span><br><span class="line">	at com.yuanrengu.demo.ZooKeeperDemo.testGet(ZooKeeperDemo.java:48)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)</span><br><span class="line">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)</span><br><span class="line">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)</span><br><span class="line">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)</span><br><span class="line">	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)</span><br><span class="line">	at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)</span><br><span class="line">	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)</span><br><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)</span><br><span class="line">	at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)</span><br><span class="line">	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)</span><br><span class="line">	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)</span><br><span class="line">	at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)</span><br><span class="line">	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)</span><br><span class="line">	at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)</span><br><span class="line">	at org.junit.runners.ParentRunner.run(ParentRunner.java:413)</span><br><span class="line">	at org.junit.runner.JUnitCore.run(JUnitCore.java:137)</span><br><span class="line">	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)</span><br><span class="line">	at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)</span><br><span class="line">	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)</span><br><span class="line">	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)</span><br><span class="line"></span><br><span class="line">Disconnected from the target VM, address: '127.0.0.1:60454', transport: 'socket'</span><br><span class="line"></span><br><span class="line">Process finished with exit code -1</span><br></pre></td></tr></table></figure>

<p>起初以为是ZooKeeper服务部署有问题或服务没启动，经检查确认无误后，debug调试发现，是SESSION_TIME_OUT = 2000;设置的值太小，改为10000后，不再报错。</p>
<blockquote>
<p>SESSION_TIME_OUT 是<code>会话超时时间</code>，也就是当一个zookeeper超过该时间没有心跳，则认为该节点故障。所以，如果此值小于zookeeper的创建时间，则当zookeeper还未来得及创建连接，会话时间已到，因此抛出异常认为该节点故障。</p>
</blockquote>
<h3 id="3-1-创建会话"><a href="#3-1-创建会话" class="headerlink" title="3.1 创建会话"></a>3.1 创建会话</h3><p>通过创建一个ZooKeeper实例来连接ZooKeeper服务器（详见<a href="https://blog.csdn.net/hyg0811/article/details/103403658" target="_blank" rel="noopener">ZooKeeper单机版、伪集群和集群环境搭建</a>）。</p>
<p>官方提供了10种ZooKeeper构造方法和描述如下：</p>
<table>
<thead>
<tr>
<th>Constructor</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly, HostProvider aHostProvider)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly, HostProvider aHostProvider, ZKClientConfig clientConfig)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly, ZKClientConfig conf)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, long sessionId, byte[] sessionPasswd)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, long sessionId, byte[] sessionPasswd, boolean canBeReadOnly)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, long sessionId, byte[] sessionPasswd, boolean canBeReadOnly, HostProvider aHostProvider)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, long sessionId, byte[] sessionPasswd, boolean canBeReadOnly, HostProvider aHostProvider, ZKClientConfig clientConfig)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
<tr>
<td>ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, ZKClientConfig conf)</td>
<td>To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</td>
</tr>
</tbody></table>
<p>关于每种构造方法的英文描述用词都很简单，基本都能看的很明白，根据实际的应用场景选取相应的构造方法。</p>
<p>有传入参数中包括sessionId和sessionPasswd的构造方法，分别代表<code>会话ID</code>和<code>会话密钥</code>。这两个参数能够唯一确定一个会话，同时客户端使用这两个参数可以<code>实现客户端会话复用</code>，从而达到恢复会话的效果。具体使用方法是第一次连接上ZooKeeper服务器时，通过调用ZooKeeper对象实例的以下两个接口，即可获取当前会话的ID和密钥：long getSessionId();  byte[] getSessionPasswd();获取到这两个参数值之后，就可以在下次创建ZooKeeper对象实例的时候传入构造方法了。</p>
<p>选取几个典型的构造方法来带领大家解读下文档。</p>
<h4 id="3-1-1-ZooKeeper-String-connectString-int-sessionTimeout-Watcher-watcher"><a href="#3-1-1-ZooKeeper-String-connectString-int-sessionTimeout-Watcher-watcher" class="headerlink" title="3.1.1 ZooKeeper(String connectString, int sessionTimeout, Watcher watcher)"></a>3.1.1 ZooKeeper(String connectString, int sessionTimeout, Watcher watcher)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">int</span> sessionTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                 Watcher watcher)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">          </span></span><br><span class="line"><span class="function">To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</span></span><br><span class="line"><span class="function">Session establishment is asynchronous. This constructor will initiate connection to the server and return immediately - <span class="title">potentially</span> <span class="params">(usually)</span> before the session is fully established. The watcher argument specifies the watcher that will be notified of any changes in state. This notification can come at any point before or after the constructor call has returned.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">The instantiated ZooKeeper client object will pick an arbitrary server from the connectString and attempt to connect to it. If establishment of the connection fails, another server in the connect string will be <span class="title">tried</span> <span class="params">(the order is non-deterministic, as we random shuffle the list)</span>, until a connection is established. The client will <span class="keyword">continue</span> attempts until the session is explicitly closed.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Added in 3.2.0: An optional "chroot" suffix may also be appended to the connection string. This will run the client commands <span class="keyword">while</span> interpreting all paths relative to <span class="keyword">this</span> <span class="title">root</span> <span class="params">(similar to the unix chroot command)</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line"><span class="function">connectString - comma separated host:port pairs, each corresponding to a zk server. e.g. "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002" If the optional chroot suffix is used the example would look like: "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a" where the client would be rooted at "/app/a" and all paths would be relative to <span class="keyword">this</span> root - ie getting/setting/etc... "/foo/bar" would result in operations being run on "/app/a/foo/bar" <span class="params">(from the server perspective)</span>.</span></span><br><span class="line"><span class="function">sessionTimeout - session timeout in milliseconds</span></span><br><span class="line"><span class="function">watcher - a watcher object which will be notified of state changes, may also be notified <span class="keyword">for</span> node events</span></span><br><span class="line"><span class="function">Throws:</span></span><br><span class="line"><span class="function">IOException - in cases of network failure</span></span><br><span class="line"><span class="function">IllegalArgumentException - <span class="keyword">if</span> an invalid chroot path is specified</span></span><br></pre></td></tr></table></figure>

<p>有一点需要特别说明下，文档说客户端和服务端建立会话是<code>异步</code>的。构造方法会在处理完客户端初始化工作后立即返回，在通常情况下，此时并没有真正建立好一个可用的会话，此时在会话的生命周期中处于“CONNECTING”的状态。当该会话真正创建完毕后，ZooKeeper服务端会向会话对应的客户端发送一个事件通知，以告知客户端，客户端只有在获取这个通知后，才算真正建立了会话。</p>
<p>实例化的ZooKeeper客户端对象将从connectString列举的服务器中<code>随机</code>选择一个服务器，并尝试连接到该服务器。如果建立连接失败，将尝试连接另一个服务器（<code>顺序是不确定的</code>，因为列举的服务器是随机洗牌的），直到建立连接。即客户端连接一个服务器失败，将继续尝试，直到会话显式关闭。</p>
<p>从<code>3.2.0版本</code>开始添加了可选的”chroot”后缀，意思就是可将“chroot”加在connectString中列举的服务器后面，即客户端连上ZooKeeper服务器后，所有对ZooKeeper的操作都会基于这个<code>根目录</code>。</p>
<p>对参数做下简要说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>connectString</td>
<td>指定ZooKeeper服务器列表，有英文逗号分隔的host：port字符串组成，如”127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002”。可以指定客户端连上connectString中服务器后的根目录，如 “127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a” ，对ZooKeeper的操作都会基于/app/a这个根目录，即创建路径为”/foo/bar”的节点，实际该节点的路径为”/app/a/foo/bar” 。</td>
</tr>
<tr>
<td>sessionTimeout</td>
<td>会话的超时事件，以“毫秒”为单位的整型值。在一个会话周期内，ZooKeeper客户端和服务器之间会通过心跳检测机制来维持会话的有效性，一旦在sessionTimeout时间内没有进行有效的心跳检测，会话就会失效。</td>
</tr>
<tr>
<td>watcher</td>
<td>ZooKeeper允许客户端在构造方法中传入一个接口Watcher（org.apache.zookeeper.Watcher）的实现类对象来作为默认的Watch事件通知器。该参数也可以设置为null，表明不需要设置默认的Watch处理器。</td>
</tr>
</tbody></table>
<h4 id="3-1-2-ZooKeeper-String-connectString-int-sessionTimeout-Watcher-watcher-boolean-canBeReadOnly"><a href="#3-1-2-ZooKeeper-String-connectString-int-sessionTimeout-Watcher-watcher-boolean-canBeReadOnly" class="headerlink" title="3.1.2 ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly)"></a>3.1.2 ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">int</span> sessionTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                 Watcher watcher,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">boolean</span> canBeReadOnly)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">          </span></span><br><span class="line"><span class="function">To create a ZooKeeper client object, the application needs to pass a connection string containing a comma separated list of host:port pairs, each corresponding to a ZooKeeper server.</span></span><br><span class="line"><span class="function">Session establishment is asynchronous. This constructor will initiate connection to the server and return immediately - <span class="title">potentially</span> <span class="params">(usually)</span> before the session is fully established. The watcher argument specifies the watcher that will be notified of any changes in state. This notification can come at any point before or after the constructor call has returned.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">The instantiated ZooKeeper client object will pick an arbitrary server from the connectString and attempt to connect to it. If establishment of the connection fails, another server in the connect string will be <span class="title">tried</span> <span class="params">(the order is non-deterministic, as we random shuffle the list)</span>, until a connection is established. The client will <span class="keyword">continue</span> attempts until the session is explicitly closed.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Added in 3.2.0: An optional "chroot" suffix may also be appended to the connection string. This will run the client commands <span class="keyword">while</span> interpreting all paths relative to <span class="keyword">this</span> <span class="title">root</span> <span class="params">(similar to the unix chroot command)</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line"><span class="function">connectString - comma separated host:port pairs, each corresponding to a zk server. e.g. "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002" If the optional chroot suffix is used the example would look like: "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a" where the client would be rooted at "/app/a" and all paths would be relative to <span class="keyword">this</span> root - ie getting/setting/etc... "/foo/bar" would result in operations being run on "/app/a/foo/bar" <span class="params">(from the server perspective)</span>.</span></span><br><span class="line"><span class="function">sessionTimeout - session timeout in milliseconds</span></span><br><span class="line"><span class="function">watcher - a watcher object which will be notified of state changes, may also be notified <span class="keyword">for</span> node events</span></span><br><span class="line"><span class="function">canBeReadOnly - <span class="params">(added in <span class="number">3.4</span>)</span> whether the created client is allowed to go to read-only mode in <span class="keyword">case</span> of partitioning. Read-only mode basically means that <span class="keyword">if</span> the client can't find any majority servers but there's partitioned server it could reach, it connects to one in read-only mode, i.e. read requests are allowed <span class="keyword">while</span> write requests are not. It continues seeking <span class="keyword">for</span> majority in the background.</span></span><br><span class="line"><span class="function">Throws:</span></span><br><span class="line"><span class="function">IOException - in cases of network failure</span></span><br><span class="line"><span class="function">IllegalArgumentException - <span class="keyword">if</span> an invalid chroot path is specified</span></span><br></pre></td></tr></table></figure>

<p>这个构造方法跟上个方法非常相似，只是从<code>3.4版本</code>开始多了一个<code>canBeReadOnly</code>参数，用于标识当前会话是否支持“read-only”模式（<code>只读模式</code>）。默认情况下，在ZooKeeper集群中，一个节点如果和集群中过半及以上节点失去网络连接（建立不了连接），那么这个机器将不再处理客户端请求（包括读写请求）。但是在某些使用场景下，当ZooKeeper服务器发生此类故障的时候，还是希望ZooKeeper服务器能够提供读服务（写服务肯定无法提供），这就是ZooKeeper的<code>“read-only”模式</code>。但客户端可以连接某一分区的服务器，它将以<strong>只读模式</strong>连接到其中一个服务器，允许读取请求，而不允许写入请求，然后继续在后台寻找更多数的服务器(<strong>这一句我描述的不够简练精准</strong>)。</p>
<h3 id="3-2-新增"><a href="#3-2-新增" class="headerlink" title="3.2 新增"></a>3.2 新增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">create</span><span class="params">(String path,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">byte</span>[] data,</span></span></span><br><span class="line"><span class="function"><span class="params">                     List&lt;ACL&gt; acl,</span></span></span><br><span class="line"><span class="function"><span class="params">                     CreateMode createMode)</span></span></span><br><span class="line"><span class="function">              <span class="keyword">throws</span> KeeperException,</span></span><br><span class="line"><span class="function">                     InterruptedException</span></span><br><span class="line"><span class="function">                     </span></span><br><span class="line"><span class="function">Create a node with the given path. The node data will be the given data, and node acl will be the given acl.</span></span><br><span class="line"><span class="function">The flags argument specifies whether the created node will be ephemeral or not.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">An ephemeral node will be removed by the ZooKeeper automatically when the session associated with the creation of the node expires.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">The flags argument can also specify to create a sequential node. The actual path name of a sequential node will be the given path plus a suffix "i" where i is the current sequential number of the node. The sequence number is always fixed length of 10 digits, 0 padded. Once such a node is created, the sequential number will be incremented by one.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">If a node with the same actual path already exists in the ZooKeeper, a KeeperException with error code KeeperException.NodeExists will be thrown. Note that since a different actual path is used <span class="keyword">for</span> each invocation of creating sequential node with the same path argument, the call will never throw "file exists" KeeperException.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">If the parent node does not exist in the ZooKeeper, a KeeperException with error code KeeperException.NoNode will be thrown.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">An ephemeral node cannot have children. If the parent node of the given path is ephemeral, a KeeperException with error code KeeperException.NoChildrenForEphemerals will be thrown.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">This operation, <span class="keyword">if</span> successful, will trigger all the watches left on the node of the given path by exists and getData API calls, and the watches left on the parent node by getChildren API calls.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">If a node is created successfully, the ZooKeeper server will trigger the watches on the path left by exists calls, and the watches on the parent of the node by getChildren calls.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">The maximum allowable size of the data array is 1 <span class="title">MB</span> <span class="params">(<span class="number">1</span>,<span class="number">048</span>,<span class="number">576</span> bytes)</span>. Arrays larger than <span class="keyword">this</span> will cause a KeeperExecption to be thrown.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line"><span class="function">path - the path <span class="keyword">for</span> the node</span></span><br><span class="line"><span class="function">data - the initial data <span class="keyword">for</span> the node</span></span><br><span class="line"><span class="function">acl - the acl <span class="keyword">for</span> the node</span></span><br><span class="line"><span class="function">createMode - specifying whether the node to be created is ephemeral and/or sequential</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line"><span class="function">the actual path of the created node</span></span><br><span class="line"><span class="function">Throws:</span></span><br><span class="line"><span class="function">KeeperException - <span class="keyword">if</span> the server returns a non-zero error code</span></span><br><span class="line"><span class="function">KeeperException.InvalidACLException - <span class="keyword">if</span> the ACL is invalid, <span class="keyword">null</span>, or empty</span></span><br><span class="line"><span class="function">InterruptedException - <span class="keyword">if</span> the transaction is interrupted</span></span><br><span class="line"><span class="function">IllegalArgumentException - <span class="keyword">if</span> an invalid path is specified</span></span><br></pre></td></tr></table></figure>

<p>Talk is cheap. Show me the code.这里我们不瞎BB，直接上官方文档。官方文档是不是很容易看懂，而且解释的非常清楚（而且稍显啰嗦的感觉）？</p>
<p><strong>这里简单列下文档中的几个关键点</strong>：</p>
<ol>
<li><p>按指定路径和节点形式创建，可指定节点为持久节点、临时节点等。<br>这里要说下<code>CreateMode</code>,大家可能都说ZooKeeper只有4种形式的节点（持久、临时、持久顺序、临时顺序），看文档的话，其实是有<code>7种</code>形式的。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">enum</span> CreateMode &#123;</span><br><span class="line">    PERSISTENT(<span class="number">0</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>),</span><br><span class="line">    PERSISTENT_SEQUENTIAL(<span class="number">2</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>),</span><br><span class="line">    EPHEMERAL(<span class="number">1</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>),</span><br><span class="line">    EPHEMERAL_SEQUENTIAL(<span class="number">3</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>),</span><br><span class="line">    CONTAINER(<span class="number">4</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>),</span><br><span class="line">    PERSISTENT_WITH_TTL(<span class="number">5</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>),</span><br><span class="line">    PERSISTENT_SEQUENTIAL_WITH_TTL(<span class="number">6</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PERSISTENT：持久节点（也有叫永久节点的），不会随着会话的结束而自动删除。</li>
<li>PERSISTENT_SEQUENTIAL：带单调递增序号的持久节点，不会随着会话的结束而自动删除。</li>
<li>EPHEMERAL：临时节点，会随着会话的结束而自动删除。</li>
<li>EPHEMERAL_SEQUENTIAL：带单调递增序号的临时节点，会随着会话的结束而自动删除。</li>
<li><code>CONTAINER</code>：容器节点，用于Leader、Lock等特殊用途，当容器节点不存在任何子节点时，容器将成为服务器在将来某个时候删除的候选节点。</li>
<li><code>PERSISTENT_WITH_TTL</code>：带TTL（time-to-live，存活时间）的持久节点，节点在TTL时间之内没有得到更新并且没有子节点，就会被自动删除。</li>
<li><code>PERSISTENT_SEQUENTIAL_WITH_TTL</code>：带TTL（time-to-live，存活时间）和单调递增序号的持久节点，节点在TTL时间之内没有得到更新并且没有子节点，就会被自动删除。</li>
</ul>
<ol start="2">
<li>如果指令路径和版本的节点已经存在，则会抛出一个KeeperException异常。</li>
<li><code>临时节点不能有子节点</code>。如果给临时节点创建子节点会抛KeeperException异常。</li>
<li>临时节点的生命周期与客户端会话绑定。<strong>一旦客户端会话失效（客户端与 Zookeeper连接断开不一定会话失效），那么这个客户端创建的所有临时节点都会被移除</strong>。</li>
<li><code>byte[] data允许的最大数据量为1MB（1,048,576 bytes）</code>。如果超过，会抛KeeperExecption。</li>
</ol>
</li>
</ol>
<p>运行创建节点的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreate</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">    zk.create(ZNODE_PATH, <span class="string">"anna2019"</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过日志信息得到节点创建成功：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG org.apache.zookeeper.ClientCnxn - Reading reply sessionid:0x101402626bb000b, packet:: clientPath:null serverPath:null finished:false header:: 1,1  replyHeader:: 1,12884901937,0  request:: '/zk_demo,#616e6e6132303139,v&#123;s&#123;31,s&#123;'world,'anyone&#125;&#125;&#125;,0  response:: '/zk_demo</span><br></pre></td></tr></table></figure>

<p>在服务端查看,/zk_demo节点创建成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 21] ls /</span><br><span class="line">[zookeeper, zk_demo]</span><br><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 22] stat /zk_demo</span><br><span class="line">cZxid = 0x300000031</span><br><span class="line">ctime = Tue Dec 17 12:52:50 CST 2019</span><br><span class="line">mZxid = 0x300000031</span><br><span class="line">mtime = Tue Dec 17 12:52:50 CST 2019</span><br><span class="line">pZxid = 0x300000031</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 8</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<h3 id="3-3-获取"><a href="#3-3-获取" class="headerlink" title="3.3 获取"></a>3.3 获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getData(String path,</span><br><span class="line">                      <span class="keyword">boolean</span> watch,</span><br><span class="line">                      Stat stat)</span><br><span class="line">               <span class="keyword">throws</span> KeeperException,</span><br><span class="line">                      InterruptedException</span><br><span class="line"></span><br><span class="line">Return the data and the stat of the node of the given path.</span><br><span class="line"><span class="function">If the watch is <span class="keyword">true</span> and the call is <span class="title">successful</span> <span class="params">(no exception is thrown)</span>, a watch will be left on the node with the given path. The watch will be triggered by a successful operation that sets data on the node, or deletes the node.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">A KeeperException with error code KeeperException.NoNode will be thrown <span class="keyword">if</span> no node with the given path exists.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line"><span class="function">path - the given path</span></span><br><span class="line"><span class="function">watch - whether need to watch <span class="keyword">this</span> node</span></span><br><span class="line"><span class="function">stat - the stat of the node</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line"><span class="function">the data of the node</span></span><br><span class="line"><span class="function">Throws:</span></span><br><span class="line"><span class="function">KeeperException - If the server signals an error with a non-zero error code</span></span><br><span class="line"><span class="function">InterruptedException - If the server transaction is interrupted.</span></span><br></pre></td></tr></table></figure>

<p>指定路径的节点不存在时就抛KeeperException.NoNode异常。</p>
<p>运行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGet</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] data1 = zk.getData(ZNODE_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] data2 = zk.getData(ZNODE_PATH_PARENT, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] data3 = zk.getData(ZNODE_PATH_CHILDREN, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    LOGGER.info(<span class="string">"&#123;&#125;的信息：&#123;&#125;"</span>, ZNODE_PATH, <span class="keyword">new</span> String(data1) );</span><br><span class="line">    LOGGER.info(<span class="string">"&#123;&#125;的信息：&#123;&#125;"</span>, ZNODE_PATH_PARENT, <span class="keyword">new</span> String(data2) );</span><br><span class="line">    LOGGER.info(<span class="string">"&#123;&#125;的信息：&#123;&#125;"</span>, ZNODE_PATH_CHILDREN, <span class="keyword">new</span> String(data3) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">13:51:00.288 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - /zk_demo的信息：anna2019</span><br><span class="line">13:51:00.288 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - /app1的信息：anna2019</span><br><span class="line">13:51:00.289 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - /app1/app1_1的信息：anna2020</span><br></pre></td></tr></table></figure>

<h3 id="3-4-更新"><a href="#3-4-更新" class="headerlink" title="3.4 更新"></a>3.4 更新</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">setData</span><span class="params">(String path,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">byte</span>[] data,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> version)</span></span></span><br><span class="line"><span class="function">             <span class="keyword">throws</span> KeeperException,</span></span><br><span class="line"><span class="function">                    InterruptedException</span></span><br><span class="line"><span class="function">                    </span></span><br><span class="line"><span class="function">Set the data <span class="keyword">for</span> the node of the given path <span class="keyword">if</span> such a node exists and the given version matches the version of the <span class="title">node</span> <span class="params">(<span class="keyword">if</span> the given version is <span class="number">-1</span>, it matches any node<span class="string">'s versions). Return the stat of the node.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">This operation, if successful, will trigger all the watches on the node of the given path left by getData calls.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">A KeeperException with error code KeeperException.NoNode will be thrown if no node with the given path exists.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">A KeeperException with error code KeeperException.BadVersion will be thrown if the given version does not match the node'</span>s version.</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">The maximum allowable size of the data array is <span class="number">1</span> MB (<span class="number">1</span>,<span class="number">048</span>,<span class="number">576</span> bytes)</span>. Arrays larger than <span class="keyword">this</span> will cause a KeeperException to be thrown.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Parameters:</span></span><br><span class="line"><span class="function">path - the path of the node</span></span><br><span class="line"><span class="function">data - the data to set</span></span><br><span class="line"><span class="function">version - the expected matching version</span></span><br><span class="line"><span class="function">Returns:</span></span><br><span class="line"><span class="function">the state of the node</span></span><br><span class="line"><span class="function">Throws:</span></span><br><span class="line"><span class="function">InterruptedException - If the server transaction is interrupted.</span></span><br><span class="line"><span class="function">KeeperException - If the server signals an error with a non-zero error code.</span></span><br><span class="line"><span class="function">IllegalArgumentException - <span class="keyword">if</span> an invalid path is specified</span></span><br></pre></td></tr></table></figure>

<p>主要注意以下几点：</p>
<ol>
<li>版本为-1时，即代表适配指定路径节点的所有版本。</li>
<li>如果指定路径的节点不存在会抛<strong>KeeperException.NoNode</strong>异常，该节点没有传入的版本，会抛<strong>KeeperException.BadVersion</strong>异常。</li>
<li><code>byte[] data允许的最大数据量为1MB（1,048,576 bytes）</code>。如果超过，会抛KeeperExecption。</li>
</ol>
<p>运行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSet</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">    Stat stat = zk.setData(ZNODE_PATH, <span class="string">"yuanrengu"</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] data = zk.getData(ZNODE_PATH, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    LOGGER.info(<span class="keyword">new</span> String(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到数据已经更新：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15:46:16.472 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - yuanrengu</span><br></pre></td></tr></table></figure>

<p>更新的接口提到了版本的概念，上面提到版本为-1时，即代表适配指定路径节点的所有版本。<code>节点每次setData时版本会加1，更新时指定的版本不存在会报KeeperException.BadVersion异常</code>。我们做个测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSetForVersion</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">    String pathVersion = <span class="string">"/versionDemo"</span>;</span><br><span class="line">    zk.create(pathVersion, <span class="string">"yuanrengu2019"</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line"></span><br><span class="line">    Stat stat = zk.setData(pathVersion, <span class="string">"yuanrengu2020"</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">    LOGGER.info(<span class="string">"============1111111  start======================"</span>);</span><br><span class="line">    LOGGER.info(String.valueOf(stat));</span><br><span class="line">    LOGGER.info(<span class="string">"version:&#123;&#125;"</span>, stat.getVersion());</span><br><span class="line">    <span class="keyword">byte</span>[] data1 = zk.getData(pathVersion, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    LOGGER.info(<span class="string">"data1:&#123;&#125;"</span>, <span class="keyword">new</span> String(data1));</span><br><span class="line">    LOGGER.info(<span class="string">"============1111111  end======================"</span>);</span><br><span class="line"></span><br><span class="line">    Stat stat2 = zk.setData(pathVersion, <span class="string">"yuanrengu2021"</span>.getBytes(), stat.getVersion());</span><br><span class="line">    LOGGER.info(<span class="string">"============222222  start======================"</span>);</span><br><span class="line">    LOGGER.info(String.valueOf(stat2));</span><br><span class="line">    LOGGER.info(<span class="string">"version2:&#123;&#125;"</span>, stat2.getVersion());</span><br><span class="line">    <span class="keyword">byte</span>[] data2 = zk.getData(pathVersion, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    LOGGER.info(<span class="string">"data2:&#123;&#125;"</span>, <span class="keyword">new</span> String(data2));</span><br><span class="line">    LOGGER.info(<span class="string">"============222222  end======================"</span>);</span><br><span class="line"></span><br><span class="line">    Stat stat3 = zk.setData(pathVersion, <span class="string">"yuanrengu2022"</span>.getBytes(), stat.getVersion());</span><br><span class="line">    LOGGER.info(<span class="string">"============3333333  start======================"</span>);</span><br><span class="line">    LOGGER.info(String.valueOf(stat3));</span><br><span class="line">    LOGGER.info(<span class="string">"version3:&#123;&#125;"</span>, stat3.getVersion());</span><br><span class="line">    <span class="keyword">byte</span>[] data3 = zk.getData(pathVersion, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    LOGGER.info(<span class="string">"data3:&#123;&#125;"</span>, <span class="keyword">new</span> String(data3));</span><br><span class="line">    LOGGER.info(<span class="string">"============3333333  end======================"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">09:56:00.931 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxn - Reading reply sessionid:0x1014dce26220008, packet:: clientPath:null serverPath:null finished:false header:: 1,5  replyHeader:: 1,12884902005,0  request:: '/versionDemo,#7975616e72656e677532303230,-1  response:: s&#123;12884901996,12884902005,1576720362715,1576720560918,1,0,0,0,13,0,12884901996&#125; </span><br><span class="line">09:56:00.940 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - ============1111111  start======================</span><br><span class="line">09:56:00.941 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - 12884901996,12884902005,1576720362715,1576720560918,1,0,0,0,13,0,12884901996</span><br><span class="line"></span><br><span class="line">09:56:00.942 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - version:1</span><br><span class="line">09:56:00.971 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxn - Reading reply sessionid:0x1014dce26220008, packet:: clientPath:null serverPath:null finished:false header:: 2,4  replyHeader:: 2,12884902005,0  request:: '/versionDemo,F  response:: #7975616e72656e677532303230,s&#123;12884901996,12884902005,1576720362715,1576720560918,1,0,0,0,13,0,12884901996&#125; </span><br><span class="line">09:56:00.971 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - data1:yuanrengu2020</span><br><span class="line">09:56:00.971 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - ============1111111  end======================</span><br><span class="line">09:56:00.988 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxn - Reading reply sessionid:0x1014dce26220008, packet:: clientPath:null serverPath:null finished:false header:: 3,5  replyHeader:: 3,12884902006,0  request:: '/versionDemo,#7975616e72656e677532303231,1  response:: s&#123;12884901996,12884902006,1576720362715,1576720561002,2,0,0,0,13,0,12884901996&#125; </span><br><span class="line">09:56:00.988 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - ============222222  start======================</span><br><span class="line">09:56:00.988 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - 12884901996,12884902006,1576720362715,1576720561002,2,0,0,0,13,0,12884901996</span><br><span class="line"></span><br><span class="line">09:56:00.990 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - version2:2</span><br><span class="line">09:56:01.017 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxn - Reading reply sessionid:0x1014dce26220008, packet:: clientPath:null serverPath:null finished:false header:: 4,4  replyHeader:: 4,12884902006,0  request:: '/versionDemo,F  response:: #7975616e72656e677532303231,s&#123;12884901996,12884902006,1576720362715,1576720561002,2,0,0,0,13,0,12884901996&#125; </span><br><span class="line">09:56:01.017 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - data2:yuanrengu2021</span><br><span class="line">09:56:01.017 [main] INFO com.yuanrengu.demo.ZooKeeperDemo - ============222222  end======================</span><br><span class="line">09:56:01.037 [main-SendThread(106.12.111.172:2181)] DEBUG org.apache.zookeeper.ClientCnxn - Reading reply sessionid:0x1014dce26220008, packet:: clientPath:null serverPath:null finished:false header:: 5,5  replyHeader:: 5,12884902007,-103  request:: '/versionDemo,#7975616e72656e677532303232,1  response::  </span><br><span class="line"></span><br><span class="line">org.apache.zookeeper.KeeperException$BadVersionException: KeeperErrorCode = BadVersion for /versionDemo</span><br><span class="line"></span><br><span class="line">	at org.apache.zookeeper.KeeperException.create(KeeperException.java:122)</span><br><span class="line">	at org.apache.zookeeper.KeeperException.create(KeeperException.java:54)</span><br><span class="line">	at org.apache.zookeeper.ZooKeeper.setData(ZooKeeper.java:2384)</span><br></pre></td></tr></table></figure>

<p>测试代码进行了3次setData操作，第一次setData时传入的版本为-1，成功后version变为1；第二次setData时传入的version为1，成功后version变为2；第三次setData时传入的版本为1，此时就抛了KeeperException.BadVersion异常。如果第三次setData传入的版本为-1，能更新成功。</p>
<h3 id="3-5-删除"><a href="#3-5-删除" class="headerlink" title="3.5 删除"></a>3.5 删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(String path,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">int</span> version)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InterruptedException,</span></span><br><span class="line"><span class="function">                   KeeperException</span></span><br><span class="line"><span class="function">                   </span></span><br><span class="line"><span class="function">Delete the node with the given path. The call will succeed <span class="keyword">if</span> such a node exists, and the given version matches the node's <span class="title">version</span> <span class="params">(<span class="keyword">if</span> the given version is <span class="number">-1</span>, it matches any node<span class="string">'s versions).</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">A KeeperException with error code KeeperException.NoNode will be thrown if the nodes does not exist.</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="string">A KeeperException with error code KeeperException.BadVersion will be thrown if the given version does not match the node'</span>s version.</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">A KeeperException with error code KeeperException.NotEmpty will be thrown <span class="keyword">if</span> the node has children.</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">This operation, <span class="keyword">if</span> successful, will trigger all the watches on the node of the given path left by exists API calls, and the watches on the parent node left by getChildren API calls.</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">Parameters:</span></span></span><br><span class="line"><span class="function"><span class="params">path - the path of the node to be deleted.</span></span></span><br><span class="line"><span class="function"><span class="params">version - the expected node version.</span></span></span><br><span class="line"><span class="function"><span class="params">Throws:</span></span></span><br><span class="line"><span class="function"><span class="params">InterruptedException - IF the server transaction is interrupted</span></span></span><br><span class="line"><span class="function"><span class="params">KeeperException - If the server signals an error with a non-zero return code.</span></span></span><br><span class="line"><span class="function"><span class="params">IllegalArgumentException - <span class="keyword">if</span> an invalid path is specified</span></span></span><br></pre></td></tr></table></figure>

<p>节点可能含有子节点，删除节点的操作有几点需要特别注意：</p>
<ol>
<li>版本为-1时，即代表适配指定路径节点的所有版本。</li>
<li>如果指定路径的节点不存在会抛KeeperException.NoNode异常，该节点没有传入的版本，会抛KeeperException.BadVersion异常。</li>
<li><code>如果节点含有子节点，删除父节点(parent node)时会抛KeeperException.NotEmpty异常。</code></li>
</ol>
<p><strong>在ZooKeeper中，只允许删子节点。如果一个节点存在一个或多个子节点，该节点就无法被直接删除，必须先删除所有子节点。</strong></p>
<p>/app1有子节点，我们做下删除操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  删除含有子节点的父节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteHasChildrenZnode</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 指定要删除的版本，-1表示删除所有版本</span></span><br><span class="line">    zk.delete(ZNODE_PATH_PARENT, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到日志：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">org.apache.zookeeper.KeeperException$NotEmptyException: KeeperErrorCode = Directory not empty for /app1</span><br><span class="line"></span><br><span class="line">	at org.apache.zookeeper.KeeperException.create(KeeperException.java:132)</span><br><span class="line">	at org.apache.zookeeper.KeeperException.create(KeeperException.java:54)</span><br><span class="line">	at org.apache.zookeeper.ZooKeeper.delete(ZooKeeper.java:1793)</span><br><span class="line">	at com.yuanrengu.demo.ZooKeeperDemo.testDeleteHasChildrenZnode(ZooKeeperDemo.java:89)</span><br></pre></td></tr></table></figure>

<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4 总结"></a>4 总结</h2><p>上面我们实现了节点的增、删、改、查的测试，后面的篇章会有更多好玩的用法，如实现分布式锁、配置中心等。</p>
<p>基于上面的分析，总结几个注意的点：</p>
<ol>
<li>节点有<code>7种形式</code>：</li>
</ol>
<ul>
<li>PERSISTENT：持久节点（也有叫永久节点的），不会随着会话的结束而自动删除。</li>
<li>PERSISTENT_SEQUENTIAL：带单调递增序号的持久节点，不会随着会话的结束而自动删除。</li>
<li>EPHEMERAL：临时节点，会随着会话的结束而自动删除。</li>
<li>EPHEMERAL_SEQUENTIAL：带单调递增序号的临时节点，会随着会话的结束而自动删除。</li>
<li><code>CONTAINER</code>：容器节点，用于Leader、Lock等特殊用途，当容器节点不存在任何子节点时，容器将成为服务器在将来某个时候删除的候选节点。</li>
<li><code>PERSISTENT_WITH_TTL</code>：带TTL（time-to-live，存活时间）的持久节点，节点在TTL时间之内没有得到更新并且没有子节点，就会被自动删除。</li>
<li><code>PERSISTENT_SEQUENTIAL_WITH_TTL</code>：带TTL（time-to-live，存活时间）和单调递增序号的持久节点，节点在TTL时间之内没有得到更新并且没有子节点，就会被自动删除。</li>
</ul>
<ol start="2">
<li><strong>临时节点不能有子节点</strong>。如果给临时节点创建子节点会抛KeeperException异常。</li>
<li>临时节点的生命周期与客户端会话绑定。<strong>一旦客户端会话失效（客户端与 Zookeeper连接断开不一定会话失效），那么这个客户端创建的所有临时节点都会被移除</strong>。</li>
<li><code>byte[] data允许的最大数据量为1MB（1,048,576 bytes）</code>。</li>
</ol>

    </div>
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/2020/3bf330a5.html" rel="bookmark">【ZooKeeper系列】1.ZooKeeper单机版、伪集群和集群环境搭建</a></div>
      
    </li>
  
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/2020/7bf54924.html" rel="bookmark">【ZooKeeper系列】3.ZooKeeper源码环境搭建</a></div>
      
    </li>
  
  </ul>



    
    
    
    <div>
      
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------本文结束<i class="fa fa-paw"></i>记得扫描下方二维码-------</div>
    
</div>

      
    </div>
      <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/images/wechat.png" alt="猿人谷 wechat" style="width: 200px; max-width: 100%;">
  <div>关注公众号可获取更多学习资料哦！</div>
</div>


    <div>
    
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">

  <p><span>本文标题:</span>【ZooKeeper系列】2.用Java实现ZooKeeper API的调用</a></p>
  <p><span>文章作者:</span>猿人谷</a></p>
  <p><span>发布时间:</span>2020年01月09日 - 16:27:32</p>
  <p><span>最后更新:</span>2020年02月14日 - 20:27:14</p>
  <p><span>原始链接:</span><a href="/2020/469cbe7.html" title="【ZooKeeper系列】2.用Java实现ZooKeeper API的调用">https://yuanrengu.com/2020/469cbe7.html</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://yuanrengu.com/2020/469cbe7.html"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({   
          title: "",   
          text: '复制成功',   
          html: false,
          timer: 500,   
          showConfirmButton: false
        });
      });
    }));  
</script>


    
    </div>

    <footer class="post-footer">
          
        
        <div class="post-tags">
            <a href="/tags/ZooKeeper/" rel="tag"><i class="fa fa-tag"></i> ZooKeeper</a>
          
            <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
          
        </div>
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
              <a href="/2020/3bf330a5.html" rel="next" title="【ZooKeeper系列】1.ZooKeeper单机版、伪集群和集群环境搭建">
                <i class="fa fa-chevron-left"></i> 【ZooKeeper系列】1.ZooKeeper单机版、伪集群和集群环境搭建
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
              <a href="/2020/7bf54924.html" rel="prev" title="【ZooKeeper系列】3.ZooKeeper源码环境搭建">
                【ZooKeeper系列】3.ZooKeeper源码环境搭建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
    </footer>
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  


        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">猿人谷</p>
  <div class="site-description motion-element" itemprop="description">技术成长，没有捷径，唯有积累。</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-简介"><span class="nav-text">1 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-测试环境搭建"><span class="nav-text">2 测试环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-API测试"><span class="nav-text">3 API测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-创建会话"><span class="nav-text">3.1 创建会话</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-ZooKeeper-String-connectString-int-sessionTimeout-Watcher-watcher"><span class="nav-text">3.1.1 ZooKeeper(String connectString, int sessionTimeout, Watcher watcher)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-ZooKeeper-String-connectString-int-sessionTimeout-Watcher-watcher-boolean-canBeReadOnly"><span class="nav-text">3.1.2 ZooKeeper(String connectString, int sessionTimeout, Watcher watcher, boolean canBeReadOnly)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-新增"><span class="nav-text">3.2 新增</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-获取"><span class="nav-text">3.3 获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-更新"><span class="nav-text">3.4 更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-删除"><span class="nav-text">3.5 删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-总结"><span class="nav-text">4 总结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">粤ICP备16101484号-1 </a>&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-fas fa-heartbeat"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">猿人谷</span>
</div>

<!-- 新增访客统计代码 -->
<div class="busuanzi-count">
    <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="site-uv">
      <i class="fa fa-user"></i>
      访问用户： <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人
    </span>
    <div class="powered-by"></div>
    <span class="site-uv">
      <i class="fa fa-eye"></i>
      访问次数： <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次
    </span>
    <!-- 博客字数统计 -->
    <span class="site-pv">
      <i class="fa fa-pencil"></i>
      博客全站共： <span class="post-count">83.3k</span> 字
    </span>
</div>
<!-- 新增访客统计代码 END-->

<!-- 在网页底部添加网站运行时间 -->
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("11/16/2019 00:00:00");//此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/schemes/muse.js?v=7.3.0"></script>


  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>



  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




































  <script type="text/javascript" src="/js/src/clicklove.js"></script>
  <script type="text/javascript" src="/js/src/clicksocialvalue.js"></script>
    
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '68e907fd5dfe1754893d',
    clientSecret: 'ed0325900afb015d44f872be297e4c2b33bc9ef6',
    repo: 'yuanrengu.github.io',
    owner: 'yuanrengu',
    admin: ['yuanrengu'],
    id: md5(location.pathname),
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>



<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</body>
</html>
